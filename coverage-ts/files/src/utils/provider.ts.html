
  <!DOCTYPE html>
  <html>
    <head>
      <title>provider.ts</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">src/utils/provider.ts</td><td class="">94.93%</td><td class="">80%</td><td class="">276</td><td class="">262</td><td class="">14</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import { NetworkName, RPC_NODES } from &#x27;../constants&#x27;;
import {
  BigNumberish,
  BlockIdentifier,
  BlockTag,
  CompiledContract,
  CompiledSierra,
  ContractClass,
  GetBlockResponse,
  InvocationsDetailsWithNonce,
  LegacyContractClass,
  PendingBlock,
  PendingStateUpdate,
  SierraContractClass,
  StateUpdateResponse,
  V3TransactionDetails,
} from &#x27;../types&#x27;;
import { ETransactionVersion } from &#x27;../types/api&#x27;;
import { isSierra } from &#x27;./contract&#x27;;
import { formatSpaces } from &#x27;./hash&#x27;;
import { parse, stringify } from &#x27;./json&#x27;;
import { isBigInt, isHex, isNumber, toHex } from &#x27;./num&#x27;;
import { isDecimalString, isString } from &#x27;./shortString&#x27;;
import { compressProgram } from &#x27;./stark&#x27;;
import type { GetTransactionReceiptResponse } from &#x27;./transactionReceipt&#x27;;

/**
 * Helper - Async Sleep for &#x27;delay&#x27; time
 */
export function wait(delay: number) {
  return new Promise((res) =&gt; {
    setTimeout(res, delay);
  });
}

/**
 * Create Sierra Contract Class from a given Compiled Sierra
 *
 * CompiledSierra -&gt; SierraContractClass
 */
export function createSierraContractClass(contract: CompiledSierra): SierraContractClass {
  const result = { ...contract } as any;
  delete result.sierra_program_debug_info;
  result.abi = formatSpaces(stringify(contract.abi));
  result.sierra_program = formatSpaces(stringify(contract.sierra_program));
  result.sierra_program = compressProgram(result.sierra_program);
  return result;
}

/**
 * Create Contract Class from a given CompiledContract or string
 *
 * (CompiledContract or string) -&gt; ContractClass
 */
export function parseContract(contract: CompiledContract | string): ContractClass {
  const parsedContract = isString(contract) ? (parse(contract) as CompiledContract) : contract;

  if (!isSierra(contract)) {
    return {
      ...parsedContract,
      ...(&#x27;program&#x27; in parsedContract &amp;&amp; { program: compressProgram(parsedContract.program) }),
    } as LegacyContractClass;
  }

  return createSierraContractClass(parsedContract as CompiledSierra);
}

/**
 * Return randomly select available public node
 * @param networkName NetworkName
 * @param mute mute public node warning
 * @returns default node url
 */
export const getDefaultNodeUrl = (networkName?: NetworkName, mute: boolean = false): string =&gt; {
  if (!mute) {
    // eslint-disable-next-line no-console
    console.warn(&#x27;Using default public node url, please provide nodeUrl in provider options!&#x27;);
  }
  const nodes = RPC_NODES[networkName ?? NetworkName.SN_SEPOLIA];
  const randIdx = Math.floor(Math.random() * nodes.length);
  return nodes[randIdx];
};

/**
 * [Reference](https://github.com/starkware-libs/cairo-lang/blob/fc97bdd8322a7df043c87c371634b26c15ed6cee/src/starkware/starknet/services/api/feeder_gateway/feeder_gateway_client.py#L148-L153)
 */
export function formatHash(hashValue: BigNumberish): string {
  if (isString(hashValue)) return hashValue;
  return toHex(hashValue);
}

/**
 * [Reference](https://github.com/starkware-libs/cairo-lang/blob/fc97bdd8322a7df043c87c371634b26c15ed6cee/src/starkware/starknet/services/api/feeder_gateway/feeder_gateway_client.py#L156-L161)
 */
export function txIdentifier(txHash?: BigNumberish, txId?: BigNumberish): string {
  if (!txHash) {
    return `transactionId=${JSON.stringify(txId)}`;
  }
  const hashString = formatHash(txHash);

  return `transactionHash=${hashString}`;
}

export const validBlockTags = Object.values(BlockTag);

/**
 * hex string and BigInt are detected as block hashes. identifier return { block_hash: hash }
 *
 * decimal string and number are detected as block numbers. identifier return { block_number: number }
 *
 * text string are detected as block tag. identifier return tag
 *
 * null is detected as &#x27;pending&#x27; block tag. identifier return &#x27;pending&#x27;
 */
export class Block {
  hash: BlockIdentifier = null;

  number: BlockIdentifier = null;

  tag: BlockIdentifier = null;

  private setIdentifier(__identifier: BlockIdentifier): void {
    if (isString(__identifier)) {
      if (isDecimalString(__identifier)) {
        this.number = parseInt(__identifier, 10);
      } else if (isHex(__identifier)) {
        this.hash = __identifier;
      } else if (validBlockTags.includes(__identifier as BlockTag)) {
        this.tag = __identifier;
      } else {
        throw TypeError(`Block identifier unmanaged: ${__identifier}`);
      }
    } else if (isBigInt(__identifier)) {
      this.hash = toHex(__identifier);
    } else if (isNumber(__identifier)) {
      this.number = __identifier;
    } else {
      this.tag = BlockTag.pending;
    }

    if (isNumber(this.number) &amp;&amp; this.number &lt; 0) {
      throw TypeError(`Block number (${this.number}) can&#x27;t be negative`);
    }
  }

  constructor(_identifier: BlockIdentifier) {
    this.setIdentifier(_identifier);
  }

  // TODO: fix any
  get queryIdentifier(): any {
    if (this.number !== null) {
      return `blockNumber=${this.number}`;
    }

    if (this.hash !== null) {
      return `blockHash=${this.hash}`;
    }

    return `blockNumber=${this.tag}`;
  }

  // TODO: fix any
  get identifier(): any {
    if (this.number !== null) {
      return { block_number: this.number };
    }

    if (this.hash !== null) {
      return { block_hash: this.hash };
    }

    return this.tag;
  }

  set identifier(_identifier: BlockIdentifier) {
    this.setIdentifier(_identifier);
  }

  valueOf = () =&gt; this.number;

  toString = () =&gt; this.hash;
}

/**
 * Check if the given transaction details is a V3 transaction.
 *
 * @param {InvocationsDetailsWithNonce} details - The transaction details to be checked.
 * @return {boolean} - Returns true if the transaction is a V3 transaction, otherwise false.
 */
export function isV3Tx(details: InvocationsDetailsWithNonce): details is V3TransactionDetails {
  const version = details.version ? toHex(details.version) : ETransactionVersion.V3;
  return version === ETransactionVersion.V3 || version === ETransactionVersion.F3;
}

/**
 * Determines if the given response matches the specified version.
 *
 * @param {(&#x27;0.5&#x27; | &#x27;0.6&#x27; | &#x27;0.7&#x27;)} version - The version to compare against the response.
 * @param {string} response - The response to check against the version.
 * @returns {boolean} - True if the response matches the version, false otherwise.
 */
export function isVersion(version: &#x27;0.5&#x27; | &#x27;0.6&#x27; | &#x27;0.7&#x27;, response: string) {
  const [majorS, minorS] = version.split(&#x27;.&#x27;);
  const [majorR, minorR] = response.split(&#x27;.&#x27;);

  return majorS === majorR &amp;&amp; minorS === minorR;
}

/**
 * Guard Pending Block
 */
export function isPendingBlock(response: GetBlockResponse): response is PendingBlock {
  return response.status === &#x27;PENDING&#x27;;
}

/**
 * Guard Pending Transaction
 */
export function isPendingTransaction(response: GetTransactionReceiptResponse): boolean {
  return !(&#x27;block_hash&#x27; in response);
}

/**
 * Guard Pending State Update
 * ex. if(isPendingStateUpdate(stateUpdate)) throw Error(&#x27;Update must be final&#x27;)
 */
export function isPendingStateUpdate(
  response: StateUpdateResponse
): response is PendingStateUpdate {
  return !(&#x27;block_hash&#x27; in response);
}
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:41,&quot;character&quot;:8,&quot;text&quot;:&quot;result&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:42,&quot;character&quot;:9,&quot;text&quot;:&quot;result&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:42,&quot;character&quot;:16,&quot;text&quot;:&quot;sierra_program_debug_info&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:43,&quot;character&quot;:2,&quot;text&quot;:&quot;result&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:43,&quot;character&quot;:9,&quot;text&quot;:&quot;abi&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:44,&quot;character&quot;:2,&quot;text&quot;:&quot;result&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:44,&quot;character&quot;:9,&quot;text&quot;:&quot;sierra_program&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:45,&quot;character&quot;:2,&quot;text&quot;:&quot;result&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:45,&quot;character&quot;:9,&quot;text&quot;:&quot;sierra_program&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:45,&quot;character&quot;:42,&quot;text&quot;:&quot;result&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:45,&quot;character&quot;:49,&quot;text&quot;:&quot;sierra_program&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:150,&quot;character&quot;:6,&quot;text&quot;:&quot;queryIdentifier&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:163,&quot;character&quot;:6,&quot;text&quot;:&quot;identifier&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/provider.ts&quot;,&quot;line&quot;:175,&quot;character&quot;:6,&quot;text&quot;:&quot;identifier&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Thu, 25 Apr 2024 15:57:37 GMT</p>
    </body>
  </html>
  